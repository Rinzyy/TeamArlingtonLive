{% extends "base.html" %}
{% block content %}
<h2>Request #{{ d.id }} ‚Äî {{ d.form_name }}</h2>

<div>
  <strong>State:</strong> {{ d.state }}
  {% if d.current_step.number %}| <strong>Step:</strong> {{ 
d.current_step.number }}{% endif %}
  {% if d.current_step.assignee %}| <strong>Assignee:</strong> {{ 
d.current_step.assignee }}{% endif %}
</div>
<div class="muted">Submitted: {{ d.submitted_at }} | Updated: {{ 
d.updated_at }}</div>

{% if view == 'approver' %}
  {% if has_pending_for_me %}
  <div style="margin: 16px 0; padding: 12px; border: 1px solid #ddd;">
    <h4>Actions</h4>
    <form method="post" action="{{ url_for('approvals_bp.approver_request_approve', request_id=d.id) }}" style="margin-bottom:8px;">
      <div>
        <label for="approve-comments">Comments (optional)</label>
        <textarea id="approve-comments" name="comments" rows="3" style="width:100%"></textarea>
      </div>
      <button type="submit">Approve</button>
    </form>
    <form method="post" action="{{ url_for('approvals_bp.approver_request_return', request_id=d.id) }}">
      <div>
        <label for="return-comments">Comments (optional)</label>
        <textarea id="return-comments" name="comments" rows="3" style="width:100%"></textarea>
      </div>
      <button type="submit">Return</button>
    </form>
  </div>
  {% else %}
  <p class="muted">Approver view</p>
  {% endif %}
{% else %}
  <p class="muted">Student view</p>
  {% if d.state == 'RETURNED' %}
    <p><a href="{{ url_for('approvals_bp.edit_request', request_id=d.id) }}">Resubmit</a></p>
  {% endif %}
{% endif %}

<h3>Fields</h3>
<table border="1" cellpadding="6" cellspacing="0">
  <tbody>
    {% for f in d.fields %}
    <tr><th>{{ f.label }}</th><td>{{ f.value }}</td></tr>
    {% endfor %}
  </tbody>
</table>

<h3>History</h3>
<ol>
  {% for e in d.history %}
  <li><strong>{{ e.event }}</strong> ‚Äî {{ e.at }} <span class="muted">({{ 
e.by }})</span></li>
  {% endfor %}
</ol>

<h3>PDFs</h3>
{% if d.pdfs|length == 0 %}
  <p><em>No PDFs generated yet. PDFs are created when approvers sign the request.</em></p>
{% else %}
  <table border="1" cellpadding="8" cellspacing="0" style="width: 100%; margin-top: 10px;">
    <thead>
      <tr>
        <th>Document</th>
        <th>Status</th>
        <th>Step</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for p in d.pdfs %}
      <tr>
        <td><strong>{{ p.name }}</strong></td>
        <td>{{ p.stateAtGen }}</td>
        <td>Step {{ p.stepNumber }}</td>
        <td>
          <a href="{{ p.url }}" target="_blank" rel="noreferrer" 
             style="padding: 6px 12px; background-color: #007bff; color: white; 
                    text-decoration: none; border-radius: 4px; display: inline-block;">
            üìÑ View PDF
          </a>
          <a href="{{ p.url }}" download="{{ p.name }}"
             style="padding: 6px 12px; background-color: #28a745; color: white; 
                    text-decoration: none; border-radius: 4px; display: inline-block; margin-left: 8px;">
            ‚¨áÔ∏è Download
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% endif %}
{% endblock %}

